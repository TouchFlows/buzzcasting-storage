<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0"
    />
    <meta name="bearer" content="%VITE_BEARER%" />
    <title>Buzzcasting Storage</title>
  </head>

  <body>
    <div id="app"></div>
    <buzzcasting-app
      channel="%VITE_CHANNEL%"
      display="%VITE_DISPLAY%"
      domain="%VITE_DOMAIN%"
      delay="0"
      moderation="realtime"
      interval="120000"
      presentation="01jc6ajqqv7ra88785zct853mm"
      before-time="00:00:00"
      storage="dexie"
    >
      <buzzcasting-presentation>
        <buzzcasting-slide
          id="%VITE_PRESENTATION%"
          class="w-[1920px] h-[1080px]"
        >
          <cloud-widget
            id="cloud"
            class="font-sans text-axa-kpi h-inherit w-inherit current"
            data-dashboard="m014uvvd_1670v2kans4xs"
            data-widget="54a5137f_8013_4d26_9fb8_d6ef2aa62917"
            data-type="cloud"
            interval="30000"
            size-multiplier="16"
            width="1300"
            height="750"
            word-padding="10"
            range="0.6,0.7,0.8,0.9"
            items="50"
            component="wordcloud-d3"
            css-highlighted="text-xl text-white upper"
            css-legend="w-60 mb-1 justify-stretch grid gap-1"
            css-key="h-3 w-3 center"
            dimensions-width="1220"
            dimensions-height="670"
            words-multiplier="20"
            words-padding="15"
            show-hashtags="false"
            show-emojis="false"
            css-host="grid font-sans"
            config-items="35"
            debug="false"
            highlight-color="#4976baff"
            show-gradient="true"
            words-range="0.6,0.7,0.8,0.9"
            css-words="font-sans fill-axa-kpi"
            css-label="text-lg"
          ></cloud-widget>
          <cards-widget
            id="messages"
            data-type="messages"
            data-moderation=""
            layout="base"
            component="card-linkedin"
            data-dashboard="lzzzniev_1670v2kaule1j"
            data-widget="859c518e_0bf6_489c_b07d_f28fe3245eec"
            css-card="text-white font-sans h-full gap-2"
            show-sender="true"
            show-brand="false"
            animation="0"
            interval="7000"
            show-date="true"
            date-format="medium"
            css-date="text-shadow-none text-sm text-gray-400"
            css-host=""
            css-body="text-lg max-h-36 text-ellipsis overflow-hidden line-clamp-5 break-keep"
            show-avatar="false"
            show-kpi="true"
            css-kpi="text-sm pr-2"
            css-avatar="max-w-16 h-16 max-h-16 w-16 rounded-full bg-contain bg-no-repeat bg-center"
            css-sender="text-ellipsis gap-x-1"
            css-brand="h-8 w-8"
            time-format=""
            css-name="font-bold text-base text-ellipsis text-nowrap overflow-hidden hidden"
            css-handle="text-sm text-ellipsis text-nowrap overflow-hidden"
            data-order="utc"
            locale="en-US"
            class="hydrated"
            index="15"
          >
          </cards-widget>
          <series-widget
            id="series"
            component="kpi-evolution"
            data-type="series"
            data-dashboard="lzzzniev_1670v2kaule1j"
            data-widget="75848543_58e8_4d44_82e2_7eb01239349a"
            css-arrow-down="bg-arrow-down-red rounded-full h-6 w-6 bg-white bg-arrow-up-green,rounded-full,h-6,w-6,bg-white"
            css-body="px-4 text-40 font-publico-light gap-x-3"
            css-brand="h-6 w-6 bg-linkedin-logo"
            css-change="font-serif-regular text-3xl text-center self-center"
            css-count="text-white font-serif-regular text-4xl self-center"
            css-down="text-white self-end"
            css-up="text-white self-end"
            class="hydrated"
          ></series-widget>
        </buzzcasting-slide>
      </buzzcasting-presentation>
    </buzzcasting-app>
    <script type="module" src="/src/index.ts"></script>

    <script type="module">
      import {
        BuzzcastingStorageManager,
        BuzzcastingStorageReader,
        Widget,
      } from ".";
      let options = {
        app: import.meta.env.VITE_APP,
        domain: import.meta.env.VITE_DOMAIN,
        version: "v4",
        token: "meta",
        bearer: import.meta.env.VITE_BEARER,
        storage: "dexie",
        channel: import.meta.env.VITE_CHANNEL,
        display: "",
        moderation: "realtime",
        beforeTime: "00:00:00",
        delay: 0,
        period: 0,
        presentation: "01j7h4f0y32njz7bthhqrtyq5s",
        suspended: true,
      };
      console.log(options);

      const bc = new BroadcastChannel(options.presentation);
      const sm = new BuzzcastingStorageManager(options);
      sm.startBroadcastListener();

      const sr = new BuzzcastingStorageReader(options);

      //bc.onmessage = (ev) => console.log(options.presentation, ev.data);

      const setData = (data) => {
        const el = document.querySelector(
          `[data-widget='${data.query.widget}']`
        );
        if (data.data) {
          el.innerHTML = JSON.stringify(data.data[data.query.type]);
        }
      };

      window.__bc = window.__bc || {};
      window.__bc["storageManager"] = sm;
      window.__bc["storageReader"] = sr;
      window.__bc["opts"] = options;

      await sm.clearHash();

      const cloud = new Widget(document.getElementById("cloud"), [setData]);

      await cloud.getCloud().then((response) => setData(response));

      const messages = new Widget(document.getElementById("messages"), [
        setData,
      ]);

      await messages.getMessages().then((response) => setData(response));

      const series = new Widget(document.getElementById("series"), [setData]);

      await series.getSeries().then((response) => setData(response));

      // const cards2 = new Widget(document.getElementById("messages"), [setData]);

      // const slides = await sm.getSlides({
      //   name: "High",
      // });
      /*console.log("slides", slides);
      const slide = await sm.getSlide({ id: "01jc6ajqr0cbpjrrvab714f3sq" });
      console.log("01jc6ajqr0cbpjrrvab714f3sq", slide);
      const subscribers = {
        "859c518e_0bf6_489c_b07d_f28fe3245eec": {
          type: "messages",
          moderation: "",
          dashboard: "lzzzniev_1670v2kaule1j",
          widget: "859c518e_0bf6_489c_b07d_f28fe3245eec",
          presentation: options.presentation,
          before: 1754656173,
          hash: "18e54848",
        },
      };

      Object.values(subscribers).forEach((apiQuery) => {
        console.log("call", apiQuery);
        // Paralelize calls
        sm.apiQuery(apiQuery);
      });*/

      setTimeout(async () => {
        bc.postMessage({
          event: "appReady",
          data: { presentation: options.presentation },
        });
      }, 10);

      setTimeout(async () => {
        await bc.postMessage({
          event: "update",
          data: { presentation: options.presentation },
        });
      }, 300);

      // setTimeout(async () => {
      //   await sm.stream();
      // }, 100);
      // setTimeout(async () => {
      //   await sm.clearHash();
      // }, 5000);
    </script>
  </body>
</html>
